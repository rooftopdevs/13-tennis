<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í…Œë‹ˆìŠ¤ ë¦¬ê·¸ ê´€ë¦¬ ì‹œìŠ¤í…œ - 17ëª… ë³µì‹ ë¦¬ê·¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none; }
            .print-break { page-break-after: always; }
        }

        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }

        .matrix-cell {
            transition: all 0.2s;
        }

        .matrix-cell:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
        }

        .sortable:hover {
            background-color: #f3f4f6;
        }

        .sort-arrow {
            display: inline-block;
            margin-left: 4px;
            opacity: 0.3;
        }

        .sort-arrow.active {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ¾ í…Œë‹ˆìŠ¤ ë¦¬ê·¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <p class="text-gray-600">17ëª… ë³µì‹ ë¦¬ê·¸ â€¢ 68ê²½ê¸° â€¢ 17ë¼ìš´ë“œ â€¢ ì™„ë²½ ê· ë“± ë¶„ë°°</p>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3 mt-4 no-print">
                <button onclick="showPlayerInputModal()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                    ë¦¬ê·¸ ì´ˆê¸°í™”
                </button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-lg shadow-lg mb-6 no-print">
            <div class="flex flex-wrap border-b">
                <button onclick="showTab('schedule')" id="tab-schedule" class="tab-active px-6 py-4 text-sm font-medium">
                    ê²½ê¸° ì¼ì •
                </button>
                <button onclick="showTab('standings')" id="tab-standings" class="px-6 py-4 text-sm font-medium text-gray-600 hover:text-gray-800">
                    ìˆœìœ„í‘œ
                </button>
                <button onclick="showTab('players')" id="tab-players" class="px-6 py-4 text-sm font-medium text-gray-600 hover:text-gray-800">
                    ì„ ìˆ˜ í†µê³„
                </button>
                <button onclick="showTab('matrix')" id="tab-matrix" class="px-6 py-4 text-sm font-medium text-gray-600 hover:text-gray-800">
                    ë§¤ì¹˜ì—… ë§¤íŠ¸ë¦­ìŠ¤
                </button>
                <button onclick="showTab('input')" id="tab-input" class="px-6 py-4 text-sm font-medium text-gray-600 hover:text-gray-800">
                    ê²°ê³¼ ì…ë ¥
                </button>
            </div>
        </div>

        <!-- Content Sections -->
        <div id="content-schedule" class="content-section">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">ê²½ê¸° ì¼ì •</h2>
                <div class="mb-4 no-print">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì„ ìˆ˜ë³„ í•„í„°:</label>
                    <select id="player-filter" onchange="renderSchedule()" class="border border-gray-300 rounded-lg px-4 py-2 w-full max-w-xs">
                        <option value="">ì „ì²´ ê²½ê¸°</option>
                    </select>
                </div>
                <div id="schedule-container"></div>
            </div>
        </div>

        <div id="content-standings" class="content-section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">ì‹¤ì‹œê°„ ìˆœìœ„í‘œ</h2>
                <div class="overflow-x-auto">
                    <table class="w-full" id="standings-table">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left sortable" onclick="sortStandings('rank')">ìˆœìœ„ <span class="sort-arrow">â–¼</span></th>
                                <th class="px-4 py-3 text-left sortable" onclick="sortStandings('player')">ì„ ìˆ˜ <span class="sort-arrow">â–¼</span></th>
                                <th class="px-4 py-3 text-center sortable" onclick="sortStandings('played')">ê²½ê¸°ìˆ˜ <span class="sort-arrow">â–¼</span></th>
                                <th class="px-4 py-3 text-center sortable" onclick="sortStandings('wins')">ìŠ¹ <span class="sort-arrow">â–¼</span></th>
                                <th class="px-4 py-3 text-center sortable" onclick="sortStandings('losses')">íŒ¨ <span class="sort-arrow">â–¼</span></th>
                                <th class="px-4 py-3 text-center sortable" onclick="sortStandings('points')">ì ìˆ˜ <span class="sort-arrow active">â–¼</span></th>
                                <th class="px-4 py-3 text-center sortable" onclick="sortStandings('winrate')">ìŠ¹ë¥  <span class="sort-arrow">â–¼</span></th>
                            </tr>
                        </thead>
                        <tbody id="standings-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="content-players" class="content-section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">ì„ ìˆ˜ í†µê³„</h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì„ ìˆ˜ ì„ íƒ:</label>
                    <select id="player-select" onchange="renderPlayerStats()" class="border border-gray-300 rounded-lg px-4 py-2 w-full max-w-xs">
                    </select>
                </div>
                <div id="player-stats-container"></div>
            </div>
        </div>

        <div id="content-matrix" class="content-section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">ë§¤ì¹˜ì—… ë§¤íŠ¸ë¦­ìŠ¤</h2>
                <div class="mb-4 text-sm">
                    <span class="inline-block w-4 h-4 bg-green-500 mr-2"></span> íŒŒíŠ¸ë„ˆë¡œ í”Œë ˆì´
                    <span class="inline-block w-4 h-4 bg-red-500 ml-4 mr-2"></span> ìƒëŒ€ë¡œ í”Œë ˆì´
                    <span class="inline-block w-4 h-4 bg-gray-200 ml-4 mr-2"></span> ì•„ì§ ë§¤ì¹˜ ì—†ìŒ
                </div>
                <div class="overflow-x-auto">
                    <div id="matrix-container"></div>
                </div>
            </div>
        </div>

        <div id="content-input" class="content-section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">ê²½ê¸° ê²°ê³¼ ì…ë ¥</h2>

                <!-- Player Filter -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì„ ìˆ˜ ì„ íƒ:</label>
                    <select id="input-player-filter" onchange="filterPendingMatches()" class="border border-gray-300 rounded-lg px-4 py-2 w-full max-w-md">
                        <option value="">ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                    <p class="text-sm text-gray-500 mt-2">ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ì„ ìˆ˜ì˜ ëª¨ë“  ëŒ€ê¸° ì¤‘ì¸ ê²½ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>

                <!-- Pending matches cards -->
                <div id="pending-matches-container" class="space-y-3">
                    <!-- Cards will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Player Input Modal -->
    <div id="player-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">ì„ ìˆ˜ ì´ë¦„ ì…ë ¥</h2>
            <p class="text-gray-600 mb-4">17ëª…ì˜ ì„ ìˆ˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”. ì…ë ¥ëœ ì´ë¦„ì€ ë¬´ì‘ìœ„ë¡œ ë°°ì¹˜ë˜ì–´ ê³µì •í•˜ê²Œ ë§¤ì¹­ë©ë‹ˆë‹¤.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 1</label>
                    <input type="text" id="player-1" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 2</label>
                    <input type="text" id="player-2" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 3</label>
                    <input type="text" id="player-3" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 4</label>
                    <input type="text" id="player-4" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 5</label>
                    <input type="text" id="player-5" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 6</label>
                    <input type="text" id="player-6" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 7</label>
                    <input type="text" id="player-7" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 8</label>
                    <input type="text" id="player-8" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 9</label>
                    <input type="text" id="player-9" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 10</label>
                    <input type="text" id="player-10" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 11</label>
                    <input type="text" id="player-11" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 12</label>
                    <input type="text" id="player-12" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 13</label>
                    <input type="text" id="player-13" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 14</label>
                    <input type="text" id="player-14" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 15</label>
                    <input type="text" id="player-15" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 16</label>
                    <input type="text" id="player-16" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„ ìˆ˜ 17</label>
                    <input type="text" id="player-17" class="border border-gray-300 rounded px-3 py-2 w-full" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="confirmResetLeague()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition">
                    ë¦¬ê·¸ ì‹œì‘
                </button>
                <button onclick="hidePlayerInputModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const TOTAL_PLAYERS = 17;
        const TARGET_GAMES = 16;
        const MATCHES_PER_ROUND = 4;
        const TOTAL_MATCHES = 68;

        // Default player names (can be overridden)
        let PLAYERS = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q'];

        // Global state
        let leagueData = {
            matches: [],
            results: {},
            playerStats: {},
            playerNames: [...PLAYERS] // Store original player names
        };

        let currentSort = { field: 'points', ascending: false };

        // Initialize player stats
        function initializePlayerStats() {
            leagueData.playerStats = {};
            PLAYERS.forEach(player => {
                leagueData.playerStats[player] = {
                    wins: 0,
                    losses: 0,
                    points: 0,
                    partners: {},
                    opponents: {},
                    matchesPlayed: 0,
                    restsUsed: 0
                };
            });
        }

        // Z-Cyclic Whist Algorithm for 17 players (Extended to 17 rounds)
        // Based on cyclic group theory for prime modulus
        // Guarantees: Each player partners with every other player exactly once (136 partnerships)
        //            Each player opposes every other player exactly twice
        function generateMatches() {
            const matches = [];
            let matchId = 1;

            // Base round configuration (proven to work with cyclic rotation)
            // This is a carefully constructed starting position
            const baseRound = [
                [[14, 15], [2, 4]],
                [[5, 8], [13, 7]],
                [[12, 16], [9, 1]],
                [[6, 11], [10, 3]]
            ];

            // Convert player letters to indices (A=0, B=1, ..., Q=16)
            const playerToIndex = (player) => PLAYERS.indexOf(player);
            const indexToPlayer = (index) => PLAYERS[index];

            // Generate 17 rounds using cyclic rotation
            for (let round = 0; round < 17; round++) {
                const roundMatches = [];

                // Player 0 sits in round 0, player 1 sits in round 1, etc.
                const sittingIndex = round % 17;
                const sittingPlayer = indexToPlayer(sittingIndex);

                // Generate 4 matches by applying cyclic shift to base round
                for (const [[a, b], [c, d]] of baseRound) {
                    const p1 = (a + round) % 17;
                    const p2 = (b + round) % 17;
                    const p3 = (c + round) % 17;
                    const p4 = (d + round) % 17;

                    roundMatches.push({
                        id: matchId++,
                        round: round + 1,
                        team1: [indexToPlayer(p1), indexToPlayer(p2)],
                        team2: [indexToPlayer(p3), indexToPlayer(p4)],
                        resting: sittingPlayer
                    });
                }

                matches.push(...roundMatches);
            }

            return matches;
        }

        // UI Functions
        function showTab(tabName) {
            // Update tab styles
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('tab-active');
                tab.classList.add('text-gray-600');
            });
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-600');

            // Show/hide content
            document.querySelectorAll('[id^="content-"]').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');

            // Render content
            switch(tabName) {
                case 'schedule':
                    renderSchedule();
                    break;
                case 'standings':
                    renderStandings();
                    break;
                case 'players':
                    renderPlayerStats();
                    break;
                case 'matrix':
                    renderMatrix();
                    break;
                case 'input':
                    renderMatchInput();
                    break;
            }
        }

        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            const filterPlayer = document.getElementById('player-filter').value;

            const filteredMatches = filterPlayer
                ? leagueData.matches.filter(m =>
                    m.team1.includes(filterPlayer) || m.team2.includes(filterPlayer))
                : leagueData.matches;

            // Group by round
            const rounds = {};
            filteredMatches.forEach(match => {
                if (!rounds[match.round]) rounds[match.round] = [];
                rounds[match.round].push(match);
            });

            let html = '';
            Object.keys(rounds).sort((a, b) => a - b).forEach(roundNum => {
                const roundMatches = rounds[roundNum];
                html += `
                    <div class="mb-6 border-l-4 border-blue-500 pl-4">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">${roundNum}ë¼ìš´ë“œ</h3>
                        <div class="space-y-3">
                `;

                roundMatches.forEach(match => {
                    const result = leagueData.results[match.id];
                    const statusClass = result ? (result.winner === 'team1' ? 'bg-green-50' : 'bg-red-50') : 'bg-white';

                    let statusBadge = '';
                    if (result) {
                        const score1 = result.score1 || 0;
                        const score2 = result.score2 || 0;
                        statusBadge = `<span class="ml-2 px-3 py-1 text-sm font-bold rounded ${result.winner === 'team1' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                            ${score1} - ${score2}
                        </span>`;
                    } else {
                        statusBadge = '<span class="ml-2 px-2 py-1 text-xs font-semibold rounded bg-gray-200 text-gray-600">ëŒ€ê¸°ì¤‘</span>';
                    }

                    html += `
                        <div class="${statusClass} border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between flex-wrap gap-2">
                                <div class="text-sm text-gray-600">ê²½ê¸° #${match.id}</div>
                                ${statusBadge}
                            </div>
                            <div class="mt-2 text-lg">
                                <span class="font-semibold text-blue-600">${match.team1.join(' & ')}</span>
                                <span class="text-gray-400 mx-3">vs</span>
                                <span class="font-semibold text-red-600">${match.team2.join(' & ')}</span>
                            </div>
                            <div class="mt-1 text-sm text-gray-500">íœ´ì‹: ${match.resting}</div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function calculateStandings() {
            const standings = PLAYERS.map(player => {
                const stats = leagueData.playerStats[player];
                return {
                    player: player,
                    played: stats.matchesPlayed,
                    wins: stats.wins,
                    losses: stats.losses,
                    points: stats.points,
                    winrate: stats.matchesPlayed > 0 ? (stats.wins / stats.matchesPlayed * 100).toFixed(1) : 0
                };
            });

            return standings.sort((a, b) => b.points - a.points || b.wins - a.wins);
        }

        function sortStandings(field) {
            if (currentSort.field === field) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.field = field;
                currentSort.ascending = false;
            }
            renderStandings();
        }

        function renderStandings() {
            const tbody = document.getElementById('standings-body');
            let standings = calculateStandings();

            // Apply sorting
            standings.sort((a, b) => {
                let aVal, bVal;
                switch(currentSort.field) {
                    case 'rank':
                        return currentSort.ascending ? 1 : -1;
                    case 'player':
                        aVal = a.player;
                        bVal = b.player;
                        break;
                    case 'played':
                        aVal = a.played;
                        bVal = b.played;
                        break;
                    case 'wins':
                        aVal = a.wins;
                        bVal = b.wins;
                        break;
                    case 'losses':
                        aVal = a.losses;
                        bVal = b.losses;
                        break;
                    case 'points':
                        aVal = a.points;
                        bVal = b.points;
                        break;
                    case 'winrate':
                        aVal = parseFloat(a.winrate);
                        bVal = parseFloat(b.winrate);
                        break;
                    default:
                        aVal = a.points;
                        bVal = b.points;
                }

                if (typeof aVal === 'string') {
                    return currentSort.ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                } else {
                    return currentSort.ascending ? aVal - bVal : bVal - aVal;
                }
            });

            // Update sort arrows
            document.querySelectorAll('.sort-arrow').forEach(arrow => arrow.classList.remove('active'));
            const sortHeader = document.querySelector(`th[onclick="sortStandings('${currentSort.field}')"] .sort-arrow`);
            if (sortHeader) {
                sortHeader.classList.add('active');
                sortHeader.textContent = currentSort.ascending ? 'â–²' : 'â–¼';
            }

            let html = '';
            standings.forEach((s, index) => {
                const rankClass = index === 0 ? 'bg-yellow-100' : index < 3 ? 'bg-blue-50' : '';
                html += `
                    <tr class="${rankClass} border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-semibold">${index + 1}</td>
                        <td class="px-4 py-3 font-bold text-blue-600">${s.player}</td>
                        <td class="px-4 py-3 text-center">${s.played}</td>
                        <td class="px-4 py-3 text-center text-green-600 font-semibold">${s.wins}</td>
                        <td class="px-4 py-3 text-center text-red-600">${s.losses}</td>
                        <td class="px-4 py-3 text-center font-bold text-lg">${s.points}</td>
                        <td class="px-4 py-3 text-center">${s.winrate}%</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function renderPlayerStats() {
            const select = document.getElementById('player-select');
            const selectedPlayer = select.value;

            if (!selectedPlayer) return;

            const container = document.getElementById('player-stats-container');
            const stats = leagueData.playerStats[selectedPlayer];

            // Get match history
            const matchHistory = leagueData.matches
                .filter(m => m.team1.includes(selectedPlayer) || m.team2.includes(selectedPlayer))
                .map(m => {
                    const result = leagueData.results[m.id];
                    const isTeam1 = m.team1.includes(selectedPlayer);
                    const partner = isTeam1 ? m.team1.find(p => p !== selectedPlayer) : m.team2.find(p => p !== selectedPlayer);
                    const opponents = isTeam1 ? m.team2 : m.team1;
                    const won = result ? (isTeam1 ? result.winner === 'team1' : result.winner === 'team2') : null;

                    return {
                        matchId: m.id,
                        round: m.round,
                        partner: partner,
                        opponents: opponents,
                        result: result ? (won ? 'Won' : 'Lost') : 'Pending'
                    };
                });

            // Partnership stats
            const partnerStats = Object.entries(stats.partners)
                .map(([partner, count]) => ({ partner, count }))
                .sort((a, b) => b.count - a.count);

            // Opposition stats
            const opponentStats = Object.entries(stats.opponents)
                .map(([opponent, count]) => ({ opponent, count }))
                .sort((a, b) => b.count - a.count);

            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-100 rounded-lg p-4">
                        <div class="text-sm text-blue-600 font-semibold">ì´ ê²½ê¸°ìˆ˜</div>
                        <div class="text-3xl font-bold text-blue-900">${stats.matchesPlayed}</div>
                    </div>
                    <div class="bg-green-100 rounded-lg p-4">
                        <div class="text-sm text-green-600 font-semibold">ìŠ¹ë¦¬</div>
                        <div class="text-3xl font-bold text-green-900">${stats.wins}</div>
                    </div>
                    <div class="bg-red-100 rounded-lg p-4">
                        <div class="text-sm text-red-600 font-semibold">íŒ¨ë°°</div>
                        <div class="text-3xl font-bold text-red-900">${stats.losses}</div>
                    </div>
                    <div class="bg-yellow-100 rounded-lg p-4">
                        <div class="text-sm text-yellow-600 font-semibold">ì ìˆ˜</div>
                        <div class="text-3xl font-bold text-yellow-900">${stats.points}</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="text-lg font-bold mb-3">íŒŒíŠ¸ë„ˆ í†µê³„</h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            ${partnerStats.length > 0 ? partnerStats.map(p => `
                                <div class="flex justify-between py-2 border-b border-gray-200 last:border-0">
                                    <span class="font-semibold">ì„ ìˆ˜ ${p.partner}</span>
                                    <span class="text-gray-600">${p.count}íšŒ</span>
                                </div>
                            `).join('') : '<div class="text-gray-500">ì•„ì§ íŒŒíŠ¸ë„ˆ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold mb-3">ìƒëŒ€ í†µê³„</h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            ${opponentStats.length > 0 ? opponentStats.map(o => `
                                <div class="flex justify-between py-2 border-b border-gray-200 last:border-0">
                                    <span class="font-semibold">ì„ ìˆ˜ ${o.opponent}</span>
                                    <span class="text-gray-600">${o.count}íšŒ</span>
                                </div>
                            `).join('') : '<div class="text-gray-500">ì•„ì§ ìƒëŒ€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-bold mb-3">ê²½ê¸° ê¸°ë¡</h3>
                    <div class="space-y-2">
                        ${matchHistory.map(m => `
                            <div class="bg-white border border-gray-200 rounded-lg p-3 ${
                                m.result === 'Won' ? 'border-l-4 border-l-green-500' :
                                m.result === 'Lost' ? 'border-l-4 border-l-red-500' : ''
                            }">
                                <div class="flex justify-between items-center flex-wrap gap-2">
                                    <div>
                                        <span class="text-sm text-gray-600">ê²½ê¸° #${m.matchId} (${m.round}ë¼ìš´ë“œ)</span>
                                        <div class="mt-1">
                                            <span class="font-semibold">íŒŒíŠ¸ë„ˆ: ${m.partner}</span>
                                            <span class="text-gray-400 mx-2">vs</span>
                                            <span class="font-semibold">${m.opponents.join(' & ')}</span>
                                        </div>
                                    </div>
                                    <span class="px-3 py-1 rounded font-semibold ${
                                        m.result === 'Won' ? 'bg-green-100 text-green-800' :
                                        m.result === 'Lost' ? 'bg-red-100 text-red-800' :
                                        'bg-gray-100 text-gray-600'
                                    }">${m.result === 'Won' ? 'ìŠ¹ë¦¬' : m.result === 'Lost' ? 'íŒ¨ë°°' : 'ëŒ€ê¸°ì¤‘'}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function renderMatrix() {
            const container = document.getElementById('matrix-container');

            // Calculate partnership and opposition matrices
            const partnerMatrix = {};
            const opponentMatrix = {};

            PLAYERS.forEach(p => {
                partnerMatrix[p] = {};
                opponentMatrix[p] = {};
                PLAYERS.forEach(other => {
                    partnerMatrix[p][other] = 0;
                    opponentMatrix[p][other] = 0;
                });
            });

            leagueData.matches.forEach(match => {
                const [p1, p2] = match.team1;
                const [p3, p4] = match.team2;

                // Partnerships
                partnerMatrix[p1][p2]++;
                partnerMatrix[p2][p1]++;
                partnerMatrix[p3][p4]++;
                partnerMatrix[p4][p3]++;

                // Oppositions
                opponentMatrix[p1][p3]++; opponentMatrix[p3][p1]++;
                opponentMatrix[p1][p4]++; opponentMatrix[p4][p1]++;
                opponentMatrix[p2][p3]++; opponentMatrix[p3][p2]++;
                opponentMatrix[p2][p4]++; opponentMatrix[p4][p2]++;
            });

            let html = '<table class="border-collapse">';

            // Header
            html += '<tr><th class="border border-gray-300 p-2 bg-gray-100 sticky top-0"></th>';
            PLAYERS.forEach(p => {
                html += `<th class="border border-gray-300 p-2 bg-gray-100 font-bold sticky top-0">${p}</th>`;
            });
            html += '</tr>';

            // Rows
            PLAYERS.forEach(row => {
                html += `<tr><td class="border border-gray-300 p-2 bg-gray-100 font-bold">${row}</td>`;
                PLAYERS.forEach(col => {
                    if (row === col) {
                        html += '<td class="border border-gray-300 p-2 bg-gray-400"></td>';
                    } else {
                        const partners = partnerMatrix[row][col];
                        const opponents = opponentMatrix[row][col];

                        let bgColor = 'bg-gray-200';
                        let text = `P:${partners} O:${opponents}`;

                        if (partners > 0 && opponents > 0) {
                            bgColor = 'bg-purple-300';
                        } else if (partners > 0) {
                            bgColor = 'bg-green-300';
                        } else if (opponents > 0) {
                            bgColor = 'bg-red-300';
                        }

                        html += `<td class="border border-gray-300 p-2 text-center text-sm matrix-cell ${bgColor}" title="${row}-${col}: ${partners} partnerships, ${opponents} oppositions">${text}</td>`;
                    }
                });
                html += '</tr>';
            });

            html += '</table>';
            container.innerHTML = html;
        }

        function renderMatchInput() {
            // Populate player filter
            const playerFilter = document.getElementById('input-player-filter');

            playerFilter.innerHTML = '<option value="">ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            PLAYERS.forEach(player => {
                playerFilter.innerHTML += `<option value="${player}">${player}</option>`;
            });

            // Initial render
            filterPendingMatches();
        }

        function filterPendingMatches() {
            const container = document.getElementById('pending-matches-container');
            const playerFilter = document.getElementById('input-player-filter').value;

            let pendingMatches = leagueData.matches.filter(m => !leagueData.results[m.id]);

            // Apply player filter - must select a player
            if (!playerFilter) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">ğŸ‘†</div>
                        <div class="text-xl font-semibold">ì„ ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                        <div class="text-sm mt-2">ìœ„ì˜ ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ì„ ìˆ˜ì˜ ê²½ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
                    </div>
                `;
                return;
            }

            pendingMatches = pendingMatches.filter(m =>
                m.team1.includes(playerFilter) || m.team2.includes(playerFilter)
            );

            // Render cards
            if (pendingMatches.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">ğŸ‰</div>
                        <div class="text-xl font-semibold">ëŒ€ê¸° ì¤‘ì¸ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤!</div>
                        <div class="text-sm mt-2">ëª¨ë“  ê²½ê¸°ê°€ ì™„ë£Œë˜ì—ˆê±°ë‚˜ í•„í„° ì¡°ê±´ì— ë§ëŠ” ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = pendingMatches.map(match => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded">
                                ${match.round}ë¼ìš´ë“œ
                            </span>
                            <span class="text-gray-500 text-sm ml-2">ê²½ê¸° #${match.id}</span>
                        </div>
                        <span class="text-xs text-gray-500">íœ´ì‹: ${match.resting}</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-3">
                            <div class="text-xs text-blue-600 font-semibold mb-1">íŒ€ 1</div>
                            <div class="text-lg font-bold text-blue-900">${match.team1.join(' & ')}</div>
                        </div>
                        <div class="bg-red-50 border-2 border-red-200 rounded-lg p-3">
                            <div class="text-xs text-red-600 font-semibold mb-1">íŒ€ 2</div>
                            <div class="text-lg font-bold text-red-900">${match.team2.join(' & ')}</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìŠ¤ì½”ì–´ ì…ë ¥:</label>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-blue-600">íŒ€ 1:</span>
                                <input type="number" id="score-team1-${match.id}" min="0" max="99"
                                       class="border border-gray-300 rounded px-3 py-2 w-20 text-center"
                                       placeholder="0">
                            </div>
                            <span class="text-xl font-bold text-gray-400">-</span>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-red-600">íŒ€ 2:</span>
                                <input type="number" id="score-team2-${match.id}" min="0" max="99"
                                       class="border border-gray-300 rounded px-3 py-2 w-20 text-center"
                                       placeholder="0">
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">* ë™ì ì€ ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ ìŠ¹íŒ¨ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</p>
                    </div>

                    <button onclick="submitScoreResult(${match.id})"
                            class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-semibold transition">
                        ê²°ê³¼ ì œì¶œ
                    </button>
                </div>
            `).join('');
        }

        function submitScoreResult(matchId) {
            // Get scores
            const score1Input = document.getElementById(`score-team1-${matchId}`);
            const score2Input = document.getElementById(`score-team2-${matchId}`);

            const score1 = parseInt(score1Input.value) || 0;
            const score2 = parseInt(score2Input.value) || 0;

            // Validation
            if (score1 === 0 && score2 === 0) {
                alert('ìŠ¤ì½”ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (score1 === score2) {
                alert('ë™ì ì€ ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ ìŠ¹íŒ¨ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            if (score1 < 0 || score2 < 0) {
                alert('ìŠ¤ì½”ì–´ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const match = leagueData.matches.find(m => m.id === matchId);
            if (!match) return;

            // Check if already submitted
            if (leagueData.results[matchId]) {
                alert('ì´ë¯¸ ê²°ê³¼ê°€ ì…ë ¥ëœ ê²½ê¸°ì…ë‹ˆë‹¤.');
                return;
            }

            // Determine winner
            const winnerTeam = score1 > score2 ? 'team1' : 'team2';

            // Confirm submission
            const winnerName = winnerTeam === 'team1' ? match.team1.join(' & ') : match.team2.join(' & ');
            if (!confirm(`${winnerName} íŒ€ì´ ${score1}-${score2}ë¡œ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤.\nê²°ê³¼ë¥¼ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            // Record result with score
            leagueData.results[matchId] = {
                winner: winnerTeam,
                score1: score1,
                score2: score2,
                timestamp: new Date().toISOString()
            };

            // Update player stats
            const winners = winnerTeam === 'team1' ? match.team1 : match.team2;
            const losers = winnerTeam === 'team1' ? match.team2 : match.team1;

            winners.forEach(player => {
                leagueData.playerStats[player].wins++;
                leagueData.playerStats[player].points += 2;
                leagueData.playerStats[player].matchesPlayed++;

                // Update partner stats
                const partner = winners.find(p => p !== player);
                if (!leagueData.playerStats[player].partners[partner]) {
                    leagueData.playerStats[player].partners[partner] = 0;
                }
                leagueData.playerStats[player].partners[partner]++;

                // Update opponent stats
                losers.forEach(opponent => {
                    if (!leagueData.playerStats[player].opponents[opponent]) {
                        leagueData.playerStats[player].opponents[opponent] = 0;
                    }
                    leagueData.playerStats[player].opponents[opponent]++;
                });
            });

            losers.forEach(player => {
                leagueData.playerStats[player].losses++;
                leagueData.playerStats[player].matchesPlayed++;

                // Update partner stats
                const partner = losers.find(p => p !== player);
                if (!leagueData.playerStats[player].partners[partner]) {
                    leagueData.playerStats[player].partners[partner] = 0;
                }
                leagueData.playerStats[player].partners[partner]++;

                // Update opponent stats
                winners.forEach(opponent => {
                    if (!leagueData.playerStats[player].opponents[opponent]) {
                        leagueData.playerStats[player].opponents[opponent] = 0;
                    }
                    leagueData.playerStats[player].opponents[opponent]++;
                });
            });

            saveData();
            alert('ê²½ê¸° ê²°ê³¼ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');

            // Refresh the match list
            filterPendingMatches();
        }

        // Data persistence
        function saveData() {
            localStorage.setItem('tennisLeagueData', JSON.stringify(leagueData));
        }

        function loadData() {
            const saved = localStorage.getItem('tennisLeagueData');
            if (saved) {
                leagueData = JSON.parse(saved);

                // Restore PLAYERS array from saved data
                if (leagueData.playerNames && leagueData.playerNames.length === 17) {
                    PLAYERS = leagueData.playerNames;
                }
            } else {
                initializeLeague();
            }
        }

        function initializeLeague() {
            initializePlayerStats();
            leagueData.matches = generateMatches();
            leagueData.results = {};
            saveData();
        }

        // Modal functions
        function showPlayerInputModal() {
            document.getElementById('player-modal').classList.remove('hidden');

            // Load saved player names if they exist
            if (leagueData.playerNames) {
                for (let i = 0; i < 17; i++) {
                    const input = document.getElementById(`player-${i + 1}`);
                    if (input) {
                        input.value = leagueData.playerNames[i] || '';
                    }
                }
            }
        }

        function hidePlayerInputModal() {
            document.getElementById('player-modal').classList.remove('hidden');
            document.getElementById('player-modal').classList.add('hidden');
        }

        function confirmResetLeague() {
            // Collect player names
            const playerNames = [];
            for (let i = 1; i <= 17; i++) {
                const input = document.getElementById(`player-${i}`);
                const name = input.value.trim();

                if (!name) {
                    alert(`ì„ ìˆ˜ ${i}ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                    input.focus();
                    return;
                }

                playerNames.push(name);
            }

            // Check for duplicate names
            const uniqueNames = new Set(playerNames);
            if (uniqueNames.size !== 17) {
                alert('ì¤‘ë³µëœ ì´ë¦„ì´ ìˆìŠµë‹ˆë‹¤. ê° ì„ ìˆ˜ëŠ” ê³ ìœ í•œ ì´ë¦„ì„ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            // Shuffle player names randomly (Fisher-Yates shuffle)
            const shuffled = [...playerNames];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }

            // Update global PLAYERS array
            PLAYERS = shuffled;
            leagueData.playerNames = shuffled;

            // Initialize league with new player names
            initializeLeague();

            // Hide modal and reload
            hidePlayerInputModal();
            location.reload();
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadData();

            // Populate dropdowns
            const playerFilter = document.getElementById('player-filter');
            const playerSelect = document.getElementById('player-select');

            PLAYERS.forEach(player => {
                playerFilter.innerHTML += `<option value="${player}">ì„ ìˆ˜ ${player}</option>`;
                playerSelect.innerHTML += `<option value="${player}">ì„ ìˆ˜ ${player}</option>`;
            });

            playerSelect.value = PLAYERS[0];

            // Show initial tab
            showTab('schedule');
        });
    </script>
</body>
</html>